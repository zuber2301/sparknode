# ──────────────────────────────────────────────────────────────
# SparkNode — CI: Build & Push Docker Images to DockerHub
#
# Step 1 of the deployment pipeline:
#   1. CI builds images and pushes to DockerHub  ← THIS WORKFLOW
#   2. Terraform provisions infrastructure
#   3. Deploy workflow pulls images onto the VM
#
# Versioning (semver):
#   - Push to main   → reads VERSION file, tags as X.Y.Z + latest
#   - Git tag v*     → uses tag version (e.g. v1.2.3 → 1.2.3)
#   - Pull request   → build only (no push)
#   - Manual dispatch → choose image + version bump, push to DockerHub
#
# Retention: only 3 semver versions kept per image (current + 2 previous).
# Older versions are automatically purged after each push.
#
# Services from docker-compose.yml:
#   backend  (build: ./backend/Dockerfile)   → zuber2301/sparknode-backend
#   celery   (same image as backend)         → zuber2301/sparknode-backend
#   frontend (build: ./frontend/Dockerfile.prod) → zuber2301/sparknode-frontend
#   postgres, redis — upstream images, not built here
#
# Required GitHub Secrets:
#   DOCKERHUB_USERNAME
#   DOCKERHUB_TOKEN

name: CI — Build & Push Images

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'VERSION'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image:
        description: 'Which image to build and push'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        description: 'Custom version (only when bump=custom, e.g. 2.0.0-rc.1)'
        required: false
        default: ''
      push:
        description: 'Push images to DockerHub'
        required: true
        default: true
        type: boolean

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write

env:
  DOCKERHUB_ORG: zuber2301
  BACKEND_IMAGE: zuber2301/sparknode-backend
  FRONTEND_IMAGE: zuber2301/sparknode-frontend
  # Number of semver versions to keep per image (current + N-1 previous)
  KEEP_VERSIONS: 3

jobs:
  # ────────────────────────────────────────────────────────────
  # Job 1: Determine version, tags & build matrix
  # ────────────────────────────────────────────────────────────
  prepare:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
      should_push: ${{ steps.version.outputs.should_push }}
      build_backend: ${{ steps.matrix.outputs.build_backend }}
      build_frontend: ${{ steps.matrix.outputs.build_frontend }}
      all_tags_backend: ${{ steps.tags.outputs.backend }}
      all_tags_frontend: ${{ steps.tags.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          # ── Resolve version from trigger type ──
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "Source: git tag (${{ github.ref }})"

          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CURRENT=$(cat VERSION | tr -d '[:space:]')

            if [ "${{ github.event.inputs.version_bump }}" = "custom" ]; then
              VERSION="${{ github.event.inputs.custom_version }}"
              if [ -z "$VERSION" ]; then
                echo "::error::custom_version is required when bump=custom"
                exit 1
              fi
            else
              IFS='.' read -r CUR_MAJOR CUR_MINOR CUR_PATCH <<< "$CURRENT"
              CUR_PATCH="${CUR_PATCH%%-*}"
              case "${{ github.event.inputs.version_bump }}" in
                major) VERSION="$((CUR_MAJOR + 1)).0.0" ;;
                minor) VERSION="${CUR_MAJOR}.$((CUR_MINOR + 1)).0" ;;
                patch) VERSION="${CUR_MAJOR}.${CUR_MINOR}.$((CUR_PATCH + 1))" ;;
              esac
            fi
            echo "Source: manual dispatch (${{ github.event.inputs.version_bump }} → $VERSION)"

          else
            VERSION=$(cat VERSION | tr -d '[:space:]')
            echo "Source: VERSION file ($VERSION)"
          fi

          # ── Validate semver ──
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "::error::Invalid semver: $VERSION (expected X.Y.Z)"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # ── Determine push ──
          SHOULD_PUSH="false"
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            SHOULD_PUSH="true"
          elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            SHOULD_PUSH="true"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.push }}" = "true" ]; then
            SHOULD_PUSH="true"
          fi
          echo "should_push=$SHOULD_PUSH" >> $GITHUB_OUTPUT

          echo "══════════════════════════════════════════"
          echo "  Version: $VERSION"
          echo "  SHA:     $SHORT_SHA"
          echo "  Push:    $SHOULD_PUSH"
          echo "══════════════════════════════════════════"

      - name: Determine build matrix
        id: matrix
        run: |
          IMAGE_INPUT="${{ github.event.inputs.image }}"

          # On push/PR events or when "all" is selected, build everything
          if [ -z "$IMAGE_INPUT" ] || [ "$IMAGE_INPUT" = "all" ]; then
            echo "build_backend=true"  >> $GITHUB_OUTPUT
            echo "build_frontend=true" >> $GITHUB_OUTPUT
          elif [ "$IMAGE_INPUT" = "backend" ]; then
            echo "build_backend=true"   >> $GITHUB_OUTPUT
            echo "build_frontend=false" >> $GITHUB_OUTPUT
          elif [ "$IMAGE_INPUT" = "frontend" ]; then
            echo "build_backend=false"  >> $GITHUB_OUTPUT
            echo "build_frontend=true"  >> $GITHUB_OUTPUT
          fi

          echo "Image selection: ${IMAGE_INPUT:-all}"

      - name: Build tag lists
        id: tags
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Tags: X.Y.Z + latest
          BACKEND_TAGS="${{ env.BACKEND_IMAGE }}:${VERSION}"
          BACKEND_TAGS="${BACKEND_TAGS},${{ env.BACKEND_IMAGE }}:latest"

          FRONTEND_TAGS="${{ env.FRONTEND_IMAGE }}:${VERSION}"
          FRONTEND_TAGS="${FRONTEND_TAGS},${{ env.FRONTEND_IMAGE }}:latest"

          echo "backend=$BACKEND_TAGS"   >> $GITHUB_OUTPUT
          echo "frontend=$FRONTEND_TAGS" >> $GITHUB_OUTPUT

      - name: Update VERSION file
        if: github.event_name == 'workflow_dispatch' && steps.version.outputs.should_push == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "$VERSION" > VERSION
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION
          git diff --cached --quiet || {
            git commit -m "chore: bump version to $VERSION [skip ci]"
            git tag "v$VERSION"
            git push origin HEAD:main --tags
          }

  # ────────────────────────────────────────────────────────────
  # Job 2: Build & push backend image
  #   (also used by celery — same Dockerfile, different CMD)
  # ────────────────────────────────────────────────────────────
  build-backend:
    name: Build Backend (${{ needs.prepare.outputs.version }})
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.build_backend == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        if: needs.prepare.outputs.should_push == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: ${{ needs.prepare.outputs.should_push == 'true' }}
          tags: ${{ needs.prepare.outputs.all_tags_backend }}
          labels: |
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Summary
        run: |
          echo "### Backend Image (also used by celery)" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** \`${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ env.BACKEND_IMAGE }}:${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Pushed:** ${{ needs.prepare.outputs.should_push }}" >> $GITHUB_STEP_SUMMARY

  # ────────────────────────────────────────────────────────────
  # Job 3: Build & push frontend image
  # ────────────────────────────────────────────────────────────
  build-frontend:
    name: Build Frontend (${{ needs.prepare.outputs.version }})
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.build_frontend == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        if: needs.prepare.outputs.should_push == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: ${{ needs.prepare.outputs.should_push == 'true' }}
          tags: ${{ needs.prepare.outputs.all_tags_frontend }}
          build-args: |
            VITE_API_URL=https://${{ vars.DOMAIN || 'app.sparknode.io' }}
          labels: |
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Summary
        run: |
          echo "### Frontend Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** \`${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ env.FRONTEND_IMAGE }}:${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Pushed:** ${{ needs.prepare.outputs.should_push }}" >> $GITHUB_STEP_SUMMARY

  # ────────────────────────────────────────────────────────────
  # Job 4: Cleanup old image versions (keep only 3 semver tags)
  #
  #   Uses DockerHub API to list tags, sorts by semver, and
  #   deletes everything beyond the 3 most recent versions.
  #   The "latest" tag is never deleted.
  # ────────────────────────────────────────────────────────────
  cleanup:
    name: Purge Old Versions
    runs-on: ubuntu-latest
    needs: [prepare, build-backend, build-frontend]
    if: |
      always() &&
      needs.prepare.outputs.should_push == 'true' &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped')
    steps:
      - name: Get DockerHub JWT token
        id: auth
        run: |
          TOKEN=$(curl -sf "https://hub.docker.com/v2/users/login" \
            -H "Content-Type: application/json" \
            -d '{"username":"${{ secrets.DOCKERHUB_USERNAME }}","password":"${{ secrets.DOCKERHUB_TOKEN }}"}' \
            | jq -r '.token')
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "::error::Failed to authenticate with DockerHub API"
            exit 1
          fi
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Purge old backend tags
        if: needs.prepare.outputs.build_backend == 'true'
        run: |
          REPO="sparknode-backend"
          ORG="${{ env.DOCKERHUB_ORG }}"
          TOKEN="${{ steps.auth.outputs.token }}"
          KEEP=${{ env.KEEP_VERSIONS }}

          echo ">>> Listing tags for $ORG/$REPO ..."
          ALL_TAGS=$(curl -sf \
            "https://hub.docker.com/v2/repositories/$ORG/$REPO/tags/?page_size=100&ordering=last_updated" \
            -H "Authorization: Bearer $TOKEN" \
            | jq -r '.results[].name')

          # Filter semver tags only (X.Y.Z), sort descending
          SEMVER_TAGS=$(echo "$ALL_TAGS" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -t. -k1,1nr -k2,2nr -k3,3nr)
          TOTAL=$(echo "$SEMVER_TAGS" | grep -c . || true)

          echo "  Found $TOTAL semver tags, keeping $KEEP"

          if [ "$TOTAL" -le "$KEEP" ]; then
            echo "  Nothing to purge."
          else
            TO_DELETE=$(echo "$SEMVER_TAGS" | tail -n +$((KEEP + 1)))
            for TAG in $TO_DELETE; do
              echo "  Deleting $ORG/$REPO:$TAG ..."
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
                "https://hub.docker.com/v2/repositories/$ORG/$REPO/tags/$TAG/" \
                -H "Authorization: Bearer $TOKEN")
              if [ "$HTTP_CODE" = "204" ]; then
                echo "    ✓ Deleted"
              else
                echo "    ✗ Failed (HTTP $HTTP_CODE)"
              fi
            done
          fi

      - name: Purge old frontend tags
        if: needs.prepare.outputs.build_frontend == 'true'
        run: |
          REPO="sparknode-frontend"
          ORG="${{ env.DOCKERHUB_ORG }}"
          TOKEN="${{ steps.auth.outputs.token }}"
          KEEP=${{ env.KEEP_VERSIONS }}

          echo ">>> Listing tags for $ORG/$REPO ..."
          ALL_TAGS=$(curl -sf \
            "https://hub.docker.com/v2/repositories/$ORG/$REPO/tags/?page_size=100&ordering=last_updated" \
            -H "Authorization: Bearer $TOKEN" \
            | jq -r '.results[].name')

          # Filter semver tags only (X.Y.Z), sort descending
          SEMVER_TAGS=$(echo "$ALL_TAGS" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -t. -k1,1nr -k2,2nr -k3,3nr)
          TOTAL=$(echo "$SEMVER_TAGS" | grep -c . || true)

          echo "  Found $TOTAL semver tags, keeping $KEEP"

          if [ "$TOTAL" -le "$KEEP" ]; then
            echo "  Nothing to purge."
          else
            TO_DELETE=$(echo "$SEMVER_TAGS" | tail -n +$((KEEP + 1)))
            for TAG in $TO_DELETE; do
              echo "  Deleting $ORG/$REPO:$TAG ..."
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
                "https://hub.docker.com/v2/repositories/$ORG/$REPO/tags/$TAG/" \
                -H "Authorization: Bearer $TOKEN")
              if [ "$HTTP_CODE" = "204" ]; then
                echo "    ✓ Deleted"
              else
                echo "    ✗ Failed (HTTP $HTTP_CODE)"
              fi
            done
          fi

      - name: Cleanup summary
        run: |
          echo "### Image Retention" >> $GITHUB_STEP_SUMMARY
          echo "Keeping **${{ env.KEEP_VERSIONS }}** most recent semver versions per image." >> $GITHUB_STEP_SUMMARY
          echo "The \`latest\` tag is always preserved." >> $GITHUB_STEP_SUMMARY

  # ────────────────────────────────────────────────────────────
  # Job 5: Output summary
  # ────────────────────────────────────────────────────────────
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [prepare, build-backend, build-frontend, cleanup]
    if: always()
    steps:
      - name: Results
        run: |
          echo "══════════════════════════════════════════"
          echo "  CI Build Results"
          echo "══════════════════════════════════════════"
          echo "  Version:  ${{ needs.prepare.outputs.version }}"
          echo "  Backend:  ${{ needs.build-backend.result }}"
          echo "  Frontend: ${{ needs.build-frontend.result }}"
          echo "  Cleanup:  ${{ needs.cleanup.result }}"
          echo "  Pushed:   ${{ needs.prepare.outputs.should_push }}"
          echo "══════════════════════════════════════════"

          echo "### CI Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-backend.result }}" != "skipped" ]; then
            echo "| Backend (+ celery) | ${{ needs.build-backend.result }} | \`${{ env.BACKEND_IMAGE }}:${{ needs.prepare.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.build-frontend.result }}" != "skipped" ]; then
            echo "| Frontend | ${{ needs.build-frontend.result }} | \`${{ env.FRONTEND_IMAGE }}:${{ needs.prepare.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Retention:** ${{ env.KEEP_VERSIONS }} versions kept per image" >> $GITHUB_STEP_SUMMARY

          # Fail if any enabled build failed
          if [ "${{ needs.build-backend.result }}" = "failure" ] || [ "${{ needs.build-frontend.result }}" = "failure" ]; then
            echo "::error::One or more image builds failed"
            exit 1
          fi
